# Модуль системы модерации: Заявки и голосования

## Обзор архитектуры

Система была переработана для улучшения масштабируемости и поддержки новых функций. Введена модульная архитектура с четким разделением ответственности между компонентами.

## Компоненты системы

### 1. Интерфейс IVoteSystem

Базовый интерфейс для всех систем голосования:

```cpp

class IVoteSystem {
public:
    virtual ~IVoteSystem() = default;
    virtual void Initialize(dpp::cluster& bot) = 0;
    virtual void ProcessButtonClick(const dpp::button_click_t& event) = 0;
    virtual void ProcessFormSubmit(const dpp::form_submit_t& event) = 0;
    virtual void SaveState() = 0;
    virtual void LoadState() = 0;
};
```
### 2. ClanApplication

Отвечает за отображение модального окна для подачи заявки:

**Методы:**

- `ShowApplicationModal()` - показывает модальное окно с формой заявки
    

### 3. CApplicationVoteSystem

Реализует систему голосования для заявок в клан:

**Методы:**

- `Initialize()` - инициализация системы голосования
    
- `ProcessButtonClick()` - обработка нажатий кнопок голосования
    
- `ProcessFormSubmit()` - обработка отправленных форм заявок
    
- `CreateVoteMessage()` - создание сообщения для голосования
    
- `FinalizeVote()` - завершение голосования и применение результатов
    
- `SaveState()` / `LoadState()` - сохранение/загрузка состояния голосований
    

### 4. Структура SApplicationVoteData

Содержит данные о голосовании:

**Поля:**

- `m_voteAccept` / `m_voteReject` - счетчики голосов
    
- `m_userData` - данные пользователя в формате JSON
    
- `m_votedUsers` - множество проголосовавших пользователей
    
- `m_targetUserId` - ID пользователя, для которого проводится голосование
    

**Методы:**

- `ToJson()` / `FromJson()` - сериализация/десериализация данных
    

## Процесс работы системы

### Подача заявки

1. Пользователь нажимает кнопку для подачи заявки
    
2. Открывается модальное окно с формой
    
3. Данные валидируются и отправляются на модерацию
    

### Голосование модераторов

1. Создается сообщение с информацией о заявке
    
2. Модераторы голосуют кнопками "Принять"/"Отклонить"
    
3. Система отслеживает уникальность голосов
    

### Завершение голосования

1. При достижении порога голосов (3) подводятся итоги
    
2. При положительном решении:
    
    - Пользователь добавляется в базу данных
        
    - Назначается соответствующая роль
        
    - Отправляется уведомление в ЛС
        
3. Состояние голосования сохраняется
    

## Расширение системы

### Добавление новых типов голосований

1. Создать новый класс, реализующий `IVoteSystem`
    
2. Реализовать методы интерфейса
    
3. Зарегистрировать в фабрике голосований
    

### Пример нового типа голосования:

```cpp
class CPollVoteSystem : public IVoteSystem {
    // Реализация методов для опросов
};
```

### Конфигурация

Система использует JSON для хранения:

- Данных голосований (`PATH_VOTES_DATA_BASE`)
    
- Данных участников (`PATH_MEMBERS_DATA_BASE`)
    
- Конфигурационных сообщений (`PATH_CONFIG`)
    

## Преимущества новой архитектуры

1. **Масштабируемость**: Легко добавлять новые типы голосований
    
2. **Поддержка**: Четкое разделение ответственности
    
3. **Надежность**: Улучшенная обработка ошибок
    
4. **Тестируемость**: Компоненты изолированы и легко тестируются
    
5. **Сохранение состояния**: Голосования сохраняются между перезапусками
    

## Пример использования

```cpp
// Инициализация в основном модуле
CApplicationVoteSystem applicationVoteSystem;
applicationVoteSystem.Initialize(bot);

// Обработка модального окна
bot.on_button_click([&](const dpp::button_click_t& event) {
    if (event.custom_id == "apply_button") {
        ClanApplication::ShowApplicationModal(event);
    }
});

// Обработка формы заявки
bot.on_form_submit([&](const dpp::form_submit_t& event) {
    if (event.custom_id == "clan_apply") {
        applicationVoteSystem.ProcessFormSubmit(event);
    }
});
```